#!/bin/sh

# Simple pre-commit hook for SpheroSeg project
set -e

echo "üîê Running pre-commit checks..."

# Check for merge conflict markers (actual Git conflict markers)
if git diff --cached --name-only | xargs grep -l "^<<<<<<< \|^>>>>>>> \|^=======$" 2>/dev/null | head -1 | grep -q .; then
    echo "‚ùå Error: Merge conflict markers found in staged files"
    exit 1
fi

# Check for debugger statements
if git diff --cached --name-only | grep -E "\.(js|jsx|ts|tsx)$" | xargs grep -l "debugger" 2>/dev/null | head -1 | grep -q .; then
    echo "‚ùå Error: Found debugger statements"
    exit 1
fi

# Run linting if available
if command -v npx >/dev/null 2>&1 && [ -f "package.json" ]; then
    echo "‚è≥ Running linter..."
    npx eslint . --max-warnings 0 || {
        echo "‚ö†Ô∏è Warning: ESLint found issues"
        echo "üîß Attempting auto-fix..."
        npx eslint . --fix || true
        git add -u
    }
    
    echo "‚è≥ Checking code formatting..."
    npx prettier --check . || {
        echo "üîß Auto-formatting code..."
        npx prettier --write .
        git add -u
    }
fi

# Check TypeScript if available
if [ -f "tsconfig.json" ] && command -v npx >/dev/null 2>&1; then
    echo "‚è≥ Checking TypeScript..."
    npx tsc --noEmit || {
        echo "‚ùå Error: TypeScript compilation failed"
        exit 1
    }
fi

echo "‚úÖ Pre-commit checks completed successfully!"
exit 0